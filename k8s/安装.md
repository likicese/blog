

# 安装

## 前言

本文所述为kubeadm安装法

所用物理机为centos stream 8

[阿里巴巴开源镜像站-OPSX镜像站-阿里云开发者社区 (aliyun.com)](https://developer.aliyun.com/mirror/)

[yaml文件参考示例](https://pkg.go.dev/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2)

物理机IP：

1. master : 172.16.1.10
2. node1 : 172.16.1.11
3. node2 : 172.16.1.12



注意，若物理机ip为192.168.0.0-192.168.15.255之内的，请指定非该范围的ip

pod的IP：192.168.1.0/20



参考：

[按照k8s权威指南安装踩坑记录](https://blog.csdn.net/zxycyj1989/article/details/117172414)

[dns查询](https://ipaddress.com/)

## 准备工作

指定域名映射

```bash
cat >> /etc/hosts << EOF
172.16.1.10 k8s-master.liki.com
172.16.1.11 k8s-node1.liki.com
172.16.1.12 k8s-node2.liki.com
EOF
```



由于master和node之间会有大量通信工作，需要进行防火墙配置。

假定机器处于安全的网络环境，为简化安装步骤，直接关闭防火墙。

```
firewall-cmd --state # 查看防火墙
systemctl stop firewalld.service  # 停止防火墙
systemctl disable firewalld.service  # 禁止开机自启
```



同理，禁止selinux，避免过于复杂的配置

```
getenforce  # 查看状态
setenforce 0  # 临时关闭
sed -i 's/^ *SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config  # 重启后，永久关闭
```

## 安装docker

参考：[docker-ce镜像-docker-ce下载地址-docker-ce安装教程-阿里巴巴开源镜像站 (aliyun.com)](https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b1121F1OP)

也可以如此配置docker的yum源

```bash
dnf install wget
wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
dnf install -y docker-ce
```



配置docker。以下内容不配置的话，kubeadm init时会报错

```
sudo mkdir /etc/docker
cat <<EOF | sudo tee /etc/docker/daemon.json
{
"exec-opts": ["native.cgroupdriver=systemd"],
"log-driver": "json-file",
"log-opts": {
"max-size": "100m"
},
"storage-driver": "overlay2"
}
EOF
```

若要更改拉取image的地址，可以在配置文件`/etc/docker/daemon.json`中添加如下参数：

```
"registry-mirrors": ["https://registry.cn-hangzhou.aliyuncs.com"]
```

## 安装k8s

参考：[kubernetes镜像-kubernetes下载地址-kubernetes安装教程-阿里巴巴开源镜像站 (aliyun.com)](https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3e221b1121F1OP)

```bash
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
setenforce 0
# master节点需要安装kubectl，node不需要安装kubectl
dnf install -y kubelet kubeadm kubectl
systemctl enable kubelet && systemctl start kubelet
```

## 启用ipvs模块

若不启用ipvs，这步可以跳过

载入内核模块命令

```bash
cat > /etc/sysconfig/modules/ipvs.modules <<EOF
 #!/bin/bash 
 modprobe -- ip_vs 
 modprobe -- ip_vs_rr 
 modprobe -- ip_vs_wrr 
 modprobe -- ip_vs_sh 
 modprobe -- nf_conntrack
EOF
```

加载模块并检查

```bash
chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4
```