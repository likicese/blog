

# 安装

## 前言

本文所述为yum安装法

[阿里巴巴开源镜像站-OPSX镜像站-阿里云开发者社区 (aliyun.com)](https://developer.aliyun.com/mirror/)

[yaml文件参考示例](https://pkg.go.dev/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2)

宿主机IP：

1. master : 172.16.1.10

2. node1 : 172.16.1.11

3. node2 : 172.16.1.12

pod的IP：192.168.201.0/24

## 准备工作

指定域名映射

```bash
cat >> /etc/hosts << EOF
172.16.1.10 k8s-master.liki.com
172.16.1.11 k8s-node1.liki.com
172.16.1.12 k8s-node1.liki.com
EOF
```



由于master和node之间会有大量通信工作，需要进行防火墙配置。

假定机器处于安全的网络环境，为简化安装步骤，直接关闭防火墙。

```
firewall-cmd --state # 查看防火墙
systemctl stop firewalld.service  # 停止防火墙
systemctl disable firewalld.service  # 禁止开机自启
```



同理，禁止selinux，避免过于复杂的配置

```
getenforce  # 查看状态
setenforce 0  # 临时关闭
sed -i 's/^ *SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config  # 重启后，永久关闭
```

## 安装docker

参考：[docker-ce镜像-docker-ce下载地址-docker-ce安装教程-阿里巴巴开源镜像站 (aliyun.com)](https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b1121F1OP)

```
# step 1: 安装必要的一些系统工具
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
# Step 2: 添加软件源信息
sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# Step 3
sudo sed -i 's+download.docker.com+mirrors.aliyun.com/docker-ce+' /etc/yum.repos.d/docker-ce.repo
# Step 4: 更新并安装Docker-CE
sudo yum makecache fast
sudo yum -y install docker-ce
```

配置docker。一下内容不配置的话，kubeadm init时会报错

```
sudo mkdir /etc/docker
cat <<EOF | sudo tee /etc/docker/daemon.json
{
"exec-opts": ["native.cgroupdriver=systemd"],
"log-driver": "json-file",
"log-opts": {
"max-size": "100m"
},
"storage-driver": "overlay2"
}
EOF
```

启动

```
# Step 4: 开启Docker服务
systemctl start docker
```

## 安装k8s

参考：[kubernetes镜像-kubernetes下载地址-kubernetes安装教程-阿里巴巴开源镜像站 (aliyun.com)](https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3e221b1121F1OP)

```bash
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
setenforce 0
# master节点需要安装kubectl，node不需要安装kubectl
yum install -y kubelet kubeadm kubectl
systemctl enable kubelet && systemctl start kubelet
```

## master节点初始化

初始化配置文件

```bash
kubeadm config print init-defaults > /opt/init.default.yaml
```

修改配置文件。其中api-server的ip：172.16.1.10和pod的ip：192.168.201.0/24根据需要进行修改。

```bash
sed -i 's#  advertiseAddress: 1.2.3.4#  advertiseAddress: 172.16.1.10#g' /opt/init.default.yaml  # 指定本机和集群通信的ip
sed -i 's#k8s.gcr.io#registry.aliyuncs.com/google_containers#g' /opt/init.default.yaml  # 替换为国内镜像源
sed -i '/networking:/a\  podSubnet: "192.168.201.0/24"' /opt/init.default.yaml  # 设定pod的ip
```

拉取镜像

```bash
kubeadm config images pull --config=/opt/init.default.yaml  # 拉取镜像
docker images -a  # 检查拉下来的镜像
```

会发现，拉取coredns镜像报错。需要改变策略，直接从docker拉取，然后改名。

```bash
kubeadm config images list  # 获取所需版本
docker pull coredns/coredns:1.8.4  # 直接拉取。注意，执行上一条命令时，显示需要拉取的镜像是k8s.gcr.io/coredns/coredns:v1.8.4，此处应该把v删除才能拉取
docker tag coredns/coredns:1.8.4 registry.aliyuncs.com/google_containers/coredns:v1.8.4
docker rmi coredns/coredns:1.8.4  # 清理镜像列表
```

安装master

```bash
kubeadm init --config=/opt/init.default.yaml
```

依照提示，将配置文件复制到用户目录下

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

验证是否启动成功

```bash
kubectl get -n kube-system configmap
```

验证节点是否准备就绪

```bash
kubectl get node  # 此时发现，节点处于NotReady状态。这是因为尚未安装网络插件
```

## 创建网络插件

下载网络插件的配置文件

```bash
# 此处可能遭遇外部网络问题
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
docker pull quay.io/coreos/flannel:v0.14.0  # 手动pull，也可让k8s自动pull。注意，版本号需要根据yaml文件的需求进行修改。
```

修改文件（仅列出需要修改的地方），填写的ip和：

```
data:
  net-conf.json: |
    {
      "Network": "192.168.201.0/24",
    }
```

启动

```bash
kubectl apply -f /opt/kube-flannel.yml  # 启动
```

## 检查集群状态

检查节点状态

```bash
kubectl get node  # 此时发现，节点处于Ready状态
```

显示如下：

```show
NAME                  STATUS   ROLES                  AGE   VERSION
k8s-master.liki.com   Ready    control-plane,master   14h   v1.22.1
```



获取集群基础pod的状态

```bash
kubectl get pod -n kube-system
```

显示如下：

```show
NAME                                          READY   STATUS    RESTARTS   AGE
coredns-7f6cbbb7b8-j2kvc                      1/1     Running   0          14h
coredns-7f6cbbb7b8-tn2s9                      1/1     Running   0          14h
etcd-k8s-master.liki.com                      1/1     Running   0          14h
kube-apiserver-k8s-master.liki.com            1/1     Running   0          14h
kube-controller-manager-k8s-master.liki.com   1/1     Running   0          14h
kube-flannel-ds-8m5zs                         1/1     Running   0          38m
kube-proxy-f8b98                              1/1     Running   0          14h
kube-scheduler-k8s-master.liki.com            1/1     Running   0          14h
```

此时还不能运行pod。因为没有node，即工作节点

## node节点加入

将前三节的准备工作、安装docker、安装k8s在node节点上依次执行。

你将会得到一个安装了k8s的机器。

此时，只需要加入k8s集群即可



### 获取join的令牌

在master上执行

```bash
kubeadm token create --print-join-command
```

会得到：

```show
kubeadm join 172.172.171.10:6443 --token bdo9on.wv28fvrul4o6f2gn --discovery-token-ca-cert-hash sha256:357fe96b0b70ea7d7c6cb22385abfd9b2b713eacf180350de407e791eeb4ef9b
```

以上令牌有效期24小时

### 加入k8s集群

在node上执行

```
kubeadm join 172.172.171.10:6443 --token bdo9on.wv28fvrul4o6f2gn --discovery-token-ca-cert-hash sha256:357fe96b0b70ea7d7c6cb22385abfd9b2b713eacf180350de407e791eeb4ef9b
```

### 查询node状态

在master上执行

```
kubectl get node
```

显示如下：

```
NAME                  STATUS     ROLES                  AGE     VERSION
k8s-master.liki.com   Ready      control-plane,master   14h     v1.22.1
k8s-node1.liki.com    NotReady   <none>                 4m56s   v1.22.1
```

发现node没有准备就绪



看看pod执行得怎么样了

```bash
kubectl get pod -n kube-system -o wide
```

显示如下：

```show
NAME                                          READY   STATUS     RESTARTS   AGE     IP               NODE                  NOMINATED NODE   READINESS GATES
coredns-7f6cbbb7b8-j2kvc                      1/1     Running    0          14h     192.168.201.3    k8s-master.liki.com   <none>           <none>
coredns-7f6cbbb7b8-tn2s9                      1/1     Running    0          14h     192.168.201.2    k8s-master.liki.com   <none>           <none>
etcd-k8s-master.liki.com                      1/1     Running    0          14h     172.172.171.10   k8s-master.liki.com   <none>           <none>
kube-apiserver-k8s-master.liki.com            1/1     Running    0          14h     172.172.171.10   k8s-master.liki.com   <none>           <none>
kube-controller-manager-k8s-master.liki.com   1/1     Running    0          14h     172.172.171.10   k8s-master.liki.com   <none>           <none>
kube-flannel-ds-8m5zs                         1/1     Running    0          54m     172.172.171.10   k8s-master.liki.com   <none>           <none>
kube-flannel-ds-x4p6c                         0/1     Init:0/1   0          5m50s   172.172.171.11   k8s-node1.liki.com    <none>           <none>
kube-proxy-f8b98                              1/1     Running    0          14h     172.172.171.10   k8s-master.liki.com   <none>           <none>
kube-proxy-kmf2x                              1/1     Running    0          5m50s   172.172.171.11   k8s-node1.liki.com    <none>           <none>
kube-scheduler-k8s-master.liki.com            1/1     Running    0          14h     172.172.171.10   k8s-master.liki.com   <none>           <none>
```

发现位于node1上的flannel还在初始化。

需要一定的时间才能完成初始化。时间花在pull镜像和设置网络上。

其设置网络可能错误一段时间。

检查pod

```bash
kubectl logs kube-flannel-ds-x4p6c -n kube-system
```

显示如下：

```
Error registering network: failed to acquire lease: node "k8s-node1.liki.com" pod cidr not assigned
```

有少量的这类报错是正常的。

若长时间报错，node一直没就绪，请参考下边的错误指导。

使用以下命令，当node也处于Ready状态时，节点即加入成功。

```
kubectl get node
```

